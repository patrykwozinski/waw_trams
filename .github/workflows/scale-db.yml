name: Scale DB & Deploy
on: workflow_dispatch

jobs:
  scale_and_deploy:
    name: Scale DB to 512MB and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      # 1. SCALE UP
      # REMOVED the '--yes' flag which caused the error.
      # This scales the VM to 512MB RAM (shared-cpu-2x)
      - name: 1. Scale Database Memory
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_ORG_API_SECRET }}
        run: flyctl scale vm shared-cpu-2x -a waw-trams-db

      # 2. DEPLOY
      # With 512MB RAM, the PostGIS extension should install without crashing.
      - name: 2. Deploy App
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_ORG_API_SECRET }}
        run: flyctl deploy --remote-only -a waw-trams
